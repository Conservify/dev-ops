version: "3.7"
services:
  proxy:
    image: "conservify/fk-cloud-proxy:active"
    networks:
      - envoy-mesh
    expose:
      - "7000"
      - "8000"
      - "9000"
    ports:
      - "7000:7000"
      - "8000:8000"
      - "9000:9000"
    logging:
      driver: "gelf"
      options:
        gelf-address: "${GELF_URL}"
        tag: "${GELF_TAGS}"

  fk-ingester:
    image: "conservify/fk-cloud-service:active"
    command: [ "/app/ingester" ]
    networks:
      - envoy-mesh
    environment:
      - TAG=${TAG}
      - HOSTNAME=${HOSTNAME}
      - FIELDKIT_TAG=${TAG}
      - FIELDKIT_SERVER_NAME=${HOSTNAME}
      - FIELDKIT_POSTGRES_URL=${DATABASE_URL}
      - FIELDKIT_DOMAIN=${ZONE_NAME}
      - FIELDKIT_PORTAL_ROOT=/app/portal
      - FIELDKIT_LEGACY_ROOT=/app/legacy
      - FIELDKIT_EMAILER=aws
      - FIELDKIT_ARCHIVER=aws
      - FIELDKIT_PRODUCTION_LOGGING=true
      - FIELDKIT_STATSD_ADDRESS=172.17.0.1:8125
    expose:
      - "8000"
    logging:
      driver: "gelf"
      options:
        gelf-address: "${GELF_URL}"
        tag: "${GELF_TAGS}"

  fk-service:
    image: "conservify/fk-cloud-service:active"
    command: [ "/app/server" ]
    networks:
      - envoy-mesh
    environment:
      - TAG=${TAG}
      - HOSTNAME=${HOSTNAME}
      - FIELDKIT_TAG=${TAG}
      - FIELDKIT_SERVER_NAME=${HOSTNAME}
      - FIELDKIT_POSTGRES_URL=${DATABASE_URL}
      - FIELDKIT_DOMAIN=${ZONE_NAME}
      - FIELDKIT_PORTAL_ROOT=/app/portal
      - FIELDKIT_LEGACY_ROOT=/app/legacy
      - FIELDKIT_EMAILER=aws
      - FIELDKIT_ARCHIVER=aws
      - FIELDKIT_PRODUCTION_LOGGING=true
      - FIELDKIT_STATSD_ADDRESS=172.17.0.1:8125
    expose:
      - "8000"
    logging:
      driver: "gelf"
      options:
        gelf-address: "${GELF_URL}"
        tag: "${GELF_TAGS}"

networks:
  envoy-mesh: {}
